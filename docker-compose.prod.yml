# Production docker-compose - uses pre-built images from GitHub Container Registry
# Usage: docker compose -f docker-compose.prod.yml up -d

services:
  redis:
    image: redis:7-alpine
    container_name: quadvault-redis
    restart: always
    command: redis-server --appendonly yes --appendfsync everysec
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  quadvault:
    image: ghcr.io/cybercorey/quadvault:latest
    container_name: quadvault
    restart: always
    privileged: true  # Required for mounting /dev/sdX inside container
    network_mode: host
    environment:
      - NODE_ENV=production
      - REDIS_URL=redis://localhost:6379
    volumes:
      - /dev:/dev
      - /run/udev:/run/udev:ro
      - network_share:/mnt/network_share
      - ./config.json:/app/config.json
      - ./storage-cache.json:/app/storage-cache.json
    depends_on:
      redis:
        condition: service_healthy

  worker:
    image: ghcr.io/cybercorey/quadvault-worker:latest
    container_name: quadvault-worker
    restart: always
    privileged: true  # Required for mounting /dev/sdX inside container
    network_mode: host
    environment:
      - NODE_ENV=production
      - REDIS_URL=redis://localhost:6379
      - FRONTEND_URL=http://localhost:3000
    volumes:
      - /dev:/dev
      - /run/udev:/run/udev:ro
      - network_share:/mnt/network_share
      - ./config.json:/app/config.json:ro
    depends_on:
      redis:
        condition: service_healthy
      quadvault:
        condition: service_started

volumes:
  redis_data:
    driver: local
  network_share:
    driver: local
    driver_opts:
      type: cifs
      device: "${SMB_SERVER}"
      o: "username=${SMB_USER},password=${SMB_PASS},vers=3.0,file_mode=0777,dir_mode=0777"
