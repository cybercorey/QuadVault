# Production docker-compose - uses pre-built images from GitHub Container Registry
# Usage: docker compose -f docker-compose.prod.yml up -d

services:
  redis:
    image: redis:7-alpine
    container_name: quadvault-redis
    restart: always
    command: redis-server --appendonly yes --appendfsync everysec
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  quadvault:
    image: ghcr.io/cybercorey/quadvault:latest
    container_name: quadvault
    restart: always
    privileged: true  # Required for mounting /dev/sdX inside container
    network_mode: host
    environment:
      - NODE_ENV=production
      - REDIS_URL=redis://localhost:6379
    volumes:
      - /dev:/dev
      - /run/udev:/run/udev:ro
      - network_share:/mnt/network_share
      - ./config.json:/app/config.json
      - ./storage-cache.json:/app/storage-cache.json
    depends_on:
      redis:
        condition: service_healthy

  worker:
    # Use ghcr.io/cybercorey/quadvault-worker:latest for GPU support
    # Use ghcr.io/cybercorey/quadvault-worker:latest-cpu for CPU-only (no stabilization)
    image: ghcr.io/cybercorey/quadvault-worker:latest
    container_name: quadvault-worker
    restart: always
    privileged: true  # Required for mounting /dev/sdX inside container
    network_mode: host
    # GPU support - comment out this section for CPU-only deployment
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu, compute, utility, video, graphics]
    environment:
      - NODE_ENV=production
      - REDIS_URL=redis://localhost:6379
      - FRONTEND_URL=http://localhost:3000
      - GPU_SUPPORT=true  # Set to false when using CPU-only image
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
      - VK_ICD_FILENAMES=/usr/share/vulkan/icd.d/nvidia_icd.json
      - VK_DRIVER_FILES=/usr/share/vulkan/icd.d/nvidia_icd.json
    volumes:
      - /dev:/dev
      - /run/udev:/run/udev:ro
      - network_share:/mnt/network_share
      - ./config.json:/app/config.json:ro
    depends_on:
      redis:
        condition: service_healthy
      quadvault:
        condition: service_started

volumes:
  redis_data:
    driver: local
  network_share:
    driver: local
    driver_opts:
      type: cifs
      device: "${SMB_SERVER}"
      o: "username=${SMB_USER},password=${SMB_PASS},vers=3.0,file_mode=0777,dir_mode=0777"
